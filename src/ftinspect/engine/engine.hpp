// engine.hpp

// Copyright (C) 2016-2022 by Werner Lemberg.


#pragma once

#include "fontfilemanager.hpp"

#include <QString>
#include <QMap>

#include <ft2build.h>
#include <freetype/freetype.h>
#include <freetype/ftoutln.h>
#include <freetype/ftcache.h>
#include <freetype/ftlcdfil.h>


// This structure maps the (font, face, instance) index triplet to abstract
// IDs (generated by a running number stored in MainGUI's `faceCounter'
// member).
//
// Qt's `QMap' class needs an implementation of the `<' operator.

struct FaceID
{
  int fontIndex;
  long faceIndex;
  int namedInstanceIndex;

  FaceID();
  FaceID(int fontIndex,
         long faceIndex,
         int namedInstanceIndex);
  bool operator<(const FaceID& other) const;
};

// FreeType specific data.

class Engine
{
public:
  //////// Nested definitions (forward decl)

  // TODO these would be dropped with custom QAbstractItemModel
  enum AntiAliasing : int;
  enum FontType : int;

  struct EngineDefaultValues
  {
    int cffHintingEngineDefault;
    int cffHintingEngineOther;

    int ttInterpreterVersionDefault;
    int ttInterpreterVersionOther;
    int ttInterpreterVersionOther1;
  };

  //////// Ctors & Dtors

  Engine();
  ~Engine();

  // Disable copying
  Engine(const Engine& other) = delete;
  Engine& operator=(const Engine& other) = delete;

  //////// Actions

  int loadFont(int fontIndex,
               long faceIndex,
               int namedInstanceIndex); // return number of glyphs
  FT_Outline* loadOutline(int glyphIndex);

  void openFonts(QStringList fontFileNames);
  void removeFont(int fontIndex, bool closeFile = true);
  
  void update();
  void resetCache();

  //////// Getters

  FT_Library ftLibrary() const { return library; }
  FontFileManager& fontFileManager() { return fileManager; }
  EngineDefaultValues& engineDefaults() { return defaults; }

  int numberOfOpenedFonts();

  // (for current fonts)
  int currentFontType() const { return fontType; }
  const QString& currentFamilyName() { return curFamilyName; }
  const QString& currentStyleName() { return curStyleName; }
  QString glyphName(int glyphIndex);
  long numberOfFaces(int fontIndex);
  int numberOfNamedInstances(int fontIndex,
                             long faceIndex);

  //////// Setters (direct or indirect)

  void setDPI(int d) { dpi = d; }
  void setSizeByPixel(double pixelSize);
  void setSizeByPoint(double pointSize);
  void setHinting(bool hinting) { doHinting = hinting; }
  void setAutoHinting(bool autoHinting) { doAutoHinting = autoHinting; }
  void setHorizontalHinting(bool horHinting)
  {
    doHorizontalHinting = horHinting;
  }
  void setVerticalHinting(bool verticalHinting)
  {
    doVerticalHinting = verticalHinting;
  }
  void setBlueZoneHinting(bool blueZoneHinting)
  {
    doBlueZoneHinting = blueZoneHinting;
  }
  void setShowSegments(bool showSegments) { this->showSegments = showSegments; }
  void setGamma(double gamma) { this->gamma = gamma; }
  void setAntiAliasingMode(AntiAliasing mode) { antiAliasingMode = mode; }

  // Note: These 3 functions now takes actual mode/version from FreeType,
  // instead of values from enum in MainGUI!
  void setLcdFilter(FT_LcdFilter filter);
  void setCFFHintingMode(int mode);
  void setTTInterpreterVersion(int version);

  //////// Misc

  friend FT_Error faceRequester(FTC_FaceID,
                                FT_Library,
                                FT_Pointer,
                                FT_Face*);

private:
  using FTC_IDType = uintptr_t;
  FTC_IDType faceCounter; // a running number used to initialize `faceIDMap'
  QMap<FaceID, FTC_IDType> faceIDMap;

  FontFileManager fileManager;

  QString curFamilyName;
  QString curStyleName;

  FT_Library library;
  FTC_Manager cacheManager;
  FTC_ImageCache imageCache;
  FTC_SBitCache sbitsCache;

  FTC_ScalerRec scaler;
  FT_Size ftSize;

  EngineDefaultValues defaults;

  int fontType;

  bool usingPixelSize = false;
  double pointSize;
  double pixelSize;
  unsigned int dpi;

  bool doHinting;
  bool doAutoHinting;
  bool doHorizontalHinting;
  bool doVerticalHinting;
  bool doBlueZoneHinting;
  bool showSegments;
  AntiAliasing antiAliasingMode;

  double gamma;

  unsigned long loadFlags;

  void queryEngine();

public:

  /// Actual definition
  
  enum AntiAliasing : int
  {
    AntiAliasing_None,
    AntiAliasing_Normal,
    AntiAliasing_Light,
    AntiAliasing_LCD,
    AntiAliasing_LCD_BGR,
    AntiAliasing_LCD_Vertical,
    AntiAliasing_LCD_Vertical_BGR
  };

  // XXX cover all available modules
  enum FontType : int
  {
    FontType_CFF,
    FontType_TrueType,
    FontType_Other
  };
};


// end of engine.hpp
